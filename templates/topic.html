{% extends "base.html" %}

{% block content %}
<h1>{{ topic.title }}</h1>
<ul id="posts">
    {% for post in topic.posts %}
    <li>
        <strong>{{ post.name }}:</strong> {{ post.message }}
        <ul>
            {% for reply in post.replies %}
            <li><strong>{{ reply.name }}:</strong> {{ reply.message }}</li>
            {% endfor %}
        </ul>
    </li>
    {% endfor %}
</ul>
<form id="addPostForm">
    <label for="name">Your Name:</label>
    <input type="text" id="name" name="name" required>
    <br>
    <label for="message">Your Message:</label>
    <textarea id="message" name="message" required></textarea>
    <br>
    <button type="submit">Add Post</button>
</form>

<script>
    document.getElementById("addPostForm").addEventListener("submit", function(event) {
        event.preventDefault(); // Спри стандартното поведение на формата

        const name = document.getElementById("name").value;
        const message = document.getElementById("message").value;

        // Изпрати AJAX заявка
        fetch(`/api/add-post/{{ topic.id }}`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ name: name, message: message })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Добавяне на новия пост към списъка
                const postsList = document.getElementById("posts");
                const newPost = document.createElement("li");
                newPost.innerHTML = `<strong>${data.post.name}:</strong> ${data.post.message}`;
                postsList.appendChild(newPost);

                // Изчистване на формата
                document.getElementById("name").value = "";
                document.getElementById("message").value = "";
            } else {
                alert(data.error || "An error occurred");
            }
        })
        .catch(error => console.error("Error:", error));
    });
</script>
{% endblock %}
